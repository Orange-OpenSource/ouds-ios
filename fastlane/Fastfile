#
# Software Name: Orange Unified Design System
# SPDX-FileCopyrightText: Copyright (c) Orange SA
# SPDX-License-Identifier: MIT
#
# This software is distributed under the MIT license,
# the text of which is available at https://opensource.org/license/MIT/
# or see the "LICENSE" file for more details.
#
# Authors: See CONTRIBUTORS.txt
# Software description: A SwiftUI components library with code examples for Orange Unified Design System
#

# Lanes
# ------

default_platform(:ios)

platform :ios do

    # ------------------------------------------------------------
    # RUN PERIPHERY FOR DEAD CODE ANALYSIS
    # ------------------------------------------------------------
    desc "Run Periphery to look dor dead code in the code base. Avoid strict mode because some false positive remains and command must be fine-tuned."
    lane :check_dead_code do
        puts "ðŸ‘‰ Check dead code with Periphery"

        # Command must run at root where Package.swift is
        sh "cd .. && periphery scan --relative-results --format xcode"
    end

    # ------------------------------------------------------------
    # RUN SWIFT FORMAT TO FORMAT SOURCES
    # ------------------------------------------------------------
    desc "Run SwiftFormat to format Swift source files according to the local configuration."
    lane :format do
        puts "ðŸ‘‰ Run Swift Format to format sources"

        template = '\\nSoftware Name: OUDS iOS\\nSPDX-FileCopyrightText: Copyright (c) Orange SA\\nSPDX-License-Identifier: MIT\\n\\nThis software is distributed under the MIT license,\\nthe text of which is available at https://opensource.org/license/MIT/\\nor see the \\"LICENSE\\" file for more details.\\n\\nAuthors: See CONTRIBUTORS.txt\\nSoftware description: A SwiftUI components library with code examples for Orange Unified Design System\\n'
        sh "cd .. && swiftformat . --exclude OUDS/Core/ThemesContract/Sources/_ThemesContract.docc/Tutorial --header \"#{template}\""
    end

    # ------------------------------------------------------------
    # RUN SWIFT LINT TO CHECK SMELLS
    # ------------------------------------------------------------
    desc "Run SwiftLint in strict mode to detect code smells"
    lane :lint do
        puts "ðŸ‘‰ Run Swift Lint for smells"

        # If there are violations, error 2 will be returned by swiftlint, making Fastlane fail (expected)
        sh "cd .. && swiftlint --strict --config .swiftlint.yml ."
    end

    # ------------------------------------------------------------
    # RUN GITLEAKS FOR SECET LEAKS SCAN
    # ------------------------------------------------------------
    desc "Run GitLeaks to look for leaks of secrets in project and Git history"
    lane :check_leaks do
        puts "ðŸ‘‰ Run Gitleaks for leaks scan"

        # If there are violations, non 0 error be returned by swiftlint, making Fastlane fail (expected)
        sh "cd .. && gitleaks detect -v -l debug --source ."
    end

    # ------------------------------------------------------------
    # RUN SYFT AND GRYPE TO BUILD AND ANALYSE SBOM
    # ------------------------------------------------------------
    desc "Generates a SBOM (Software Bill Of Materials) in SPDX JSON format with Syft and analyse it with Grype to as to check for vulnerabilities"
    lane :update_sbom do
        puts "ðŸ‘‰ Run Syft to generate the SBOM"
        
        # Or also cyclonedx-json
        sbomFormat = "spdx-json"

        # In { negligible, low, medium, high, critical }
        vulnerabilitiesTolerance = "negligible"

        Dir.chdir ".." do
            # Run the command to generate SBOM
            sh "syft . -o #{sbomFormat} > SBOM.json"

            # Process the SBOM
            sh "grype sbom:./SBOM.json --fail-on #{vulnerabilitiesTolerance}"
        end
    end

    # ------------------------------------------------------------
    # BUILD
    # ------------------------------------------------------------
    desc "Build the Swift Package to be sure the package is compilable"
    lane :build do
        puts "ðŸ‘‰ Build Swift Package"

        sh "cd .. && swift build"
    end

    # ------------------------------------------------------------
    # RUN UNIT TESTS
    # ------------------------------------------------------------
    desc "Run the unit tests embeded in the Swift Package project"
    lane :test_unit do
        puts "ðŸ‘‰ Run unit tests of Swift Package"

        sh "cd .. && swift test"
    end
end